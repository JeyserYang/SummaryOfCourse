[TOC]

### 基础

1. 基本概念
  > - 用户与之交互的程序，基于文本的称为shell，基于图标的称为GUI
  > - 操作系统是一种运行在内核态的软件，它的主要任务是记录哪个程序在使用哪个资源，对资源请求进行分配，并且调解互相冲突的资源请求
  > - 并发是指同一时间间隔运行多个事件，并行是指同一时刻运行多个事件
  > - BIOS是存放在ROM中用于启动计算机的，操作系统是存放在RAM中的。

2. 批处理系统，分时系统，实时系统
  > - 批处理系统包括单道批处理系统和多道批处理系统，具有交互性差，CPU利用率高的特点
  > - 分时系统交互性较好
  > - 实时系统具有及时性和可靠性的特点，

* 什么是多道程序设计
多道程序设计是为了当一个或多个进程在做IO操作时，CPU保持忙碌，而不是空闲。同时使CPU在多个进程之间迅速切换，需要使用中断技术实现切换。

* DMA对于多道程序设计有何意义
多道程序设计的主要原因是当等待IO完成时CPU有事可做，如果没有DMA，则IO操作时CPU被完全占有，因此多道程序设计就没有办法实现。

* 下面哪条指令只能在内核态使用
  > 1. 禁止所有的中断
  > 2. 读日期-时间时钟
  > 3. 设置日期-时间时钟
  > 4. 改变存储器映像(进程切换)
  > 5. Answer： 1， 3， 4 应该在内核态运行。

* 什么使trap指令，在操作系统中解释它的用途
陷阱指令将一个CPU的执行模式从用户态切换到内核态。该指令允许用户程序调用操作系统内核中的函数。

* 陷阱和中断的区别
陷阱是由程序造成的，如果程序一而再地被运行，陷阱总在指令流的相同位置精确发生。而中断是由外部事件和其时钟造成的，不具有重复性。

* 中断和异常（内中断）
中断，也称为外中断，指CPU执行指令以外的事件的发生，比如IO中断，时钟中断
异常，也称为内中断，指CPU执行指令过程中发生的事件，比如除零，地址越界，非法，缺页中断等

* 进程表的用途
进程表用于存储当前被挂起，就绪，阻塞的进程状态。

#### 典型例题

1. 与单道程序系统相比，多道程序系统的优点有（ ）

    > Answer： CPU利用率高， 系统吞吐量大， IO设备利用率也高。

2. 下列选项中在用户态执行的是（ ）

    A. 命令解释程序	B. 缺页处理程序	C. 进程调度程序	D. 时钟中断处理程序

    > Answer： A，可以将命令解释程序看成Shell，这当然是在用户态执行的，中断处理程序和进程调度是在核心态执行的。

3. 下列选项中不可能在用户态发生的是（ ）

    A. 系统调用	B. 外部中断	C. 进程切换	D. 缺页

    > Answer： C，这里与上一题不同，注意发生和执行的区别。

4. 下列关于内部异常的说法中，错误的是（ ）

    A. 内部异常的产生与当前执行指令有关	B. 内部异常的检测由CPU内部逻辑实现

    C. 内部异常的响应发生在指令执行过程中	D. 内部异常处理后返回到发生异常的指令继续执行

    > Answer： D，由异常的概念可知，A正确；异常一旦发生，立即被处理，C正确；D不正确，举例如下：当发生除数为0的异常时，怎么可能返回回去继续执行。

### 进程与线程

1. 进程阻塞在IO操作的含义

    > 当一个进程需要打印一页内容时，CPU运行首先将字符输入到打印机的字符缓冲区中，这时打印机需要将缓冲区的字符打印到纸上（我们把这个操作叫做IO操作），此时由于进程啥事也干不了，只能等待打印机将缓冲区字符打印完，我们称之为进程阻塞在IO操作上。当字符打印完毕后，进程会进入到就绪态，执行下一步操作（继续打印或终止）。（几乎所有的输出设备都有存放字符的缓冲区，显示器也不例外）

* PCB（进程控制块）是进程存在的唯一标志。

* 线程共有的东西和独有的东西

    > 进程中的线程共享 进程的地址空间，全局变量，打开的文件等； 每个线程都有的内容包括程序计数器，寄存器，堆栈等。

* 进程是分配资源的最小单位，线程是执行（调度）的最小单位。

* 进程状态总共有三种，理论上有六种转换，书中只给出了四种转换。有没有可能发生其他两种转换的一个或两个？

    > 从阻塞态到运行时可能的。假设当前某个进程在IO上阻塞，而且IO结束，如果此时CPU空闲，该进程就可以从阻塞太直接转到运行态。而从就绪态到阻塞态是不可能的，只有运行中的进程才能被阻塞。

* 多个作业并行工作，比它们顺序执行完成的要快。假设两个作业同时开始执行，每个需要10分钟CPU时间，如果顺序执行，那么最后一个作业需要多长时间可以完成？假设IO等待时间占50%。

    > Answer： 当程序顺序执行时，每个程序完成都需要花费20minutes，两个任务共需要40minutes。
当程序并行执行时，由CPU利用率公式：1-p^n = 1 - 0.5^2 = 0.75.所以花费时间等于 总共用于
CPU的时间 / CPU利用率 = （10 + 10） / 0.75 = 26.67minutes。

* 任务（进程）调度原则
  > - CPU利用率
  > - 系统吞吐量（单位时间CPU完成作业的数量）
  > - 周转时间（从作业提交到作业完成所需要的时间）

* 调度算法
  > - FCFS（先来先服务）
  > - SJF（最短作业优先）
  > - 优先级调度
  > - 高响应比调度（同时考虑等待时间和运行时间）
  > - 时间片轮转
  > - 多级反馈队列（时间片轮转和优先级调度的综合，动态调整优先级和时间片大小）

* 经典同步互斥问题（IPC）
    - 生产者-消费者问题
```
semaphore mutex = 1;					//临界区（缓冲区）互斥信号量
semaphore empty = n;
semaphore full = 0;
producer(){
	while(1){
		produce a item;
		P(empty);
		P(mutex);
		add the item to the buffer;
		V(mutex);
		V(full);
	}
}
consumer(){
	while(1){
		P(full);
		P(mutex);
		remove a item from the buffer;
		V(mutex);
		V(empty);
		consume the item;
	}
}
```
  - 读者-写者问题

  问题描述：有读者和写者两组并发进程，共享一个文件，可以有两个以上的读进程同时访问，只允许一个写进程向文件中写信息，任一写者在完成写操作之前不允许其他读者或写者工作，写者执行写操作之前，应让写者和读者全部退出。

  分析：读者和写者是互斥关系，写者和写者也是互斥关系
```
semaphore count = 0;					//记录当前读者数量
semaphore mutex = 1;					//互斥访问count变量
semaphore rw = 1;						//互斥访问共享文件
writer(){
	while(1){
		P(rw);
		writing;
		V(rw);
	}
}
reader(){
	while(1){
		//首先对count访问，只有当读者数量为0时，才需要互斥访问文件
		P(mutex);
		if(count == 0){
			P(rw);
		}
		count++;
		V(mutex);
		reading;
		P(mutex);
		count--;
		if(count == 0){
			V(rw);				//只有当当前读者退出时，读者为0，写者才有可能运行。
		}
		V(mutex);
	}
}
```
  - 哲学家就餐

  下面是针对哲学家就餐问题死锁预防的一种策略，破坏了占有和等待条件，即开始就请求全部资源。另一种解决办法是在Java编程思想中提到的，即前面n-1个进程都是先拿左筷子，再拿右筷子，让最后一个进程先拿右筷子，再拿左筷子。这种方法破坏了循环等待条件。
```
semaphore chopstick[5] = { 1, 1, 1, 1, 1 };		//共享资源筷子信号量
semaphore mutex = 1;								//互斥访问筷子（左右两根）
Pi(){
	while(1){
		P(mutex);
		P(chopstick[i]);
		P(chopstick[(i+1) % 5]);
		V(mutex);
		eating;
		V(chopstick[i]);
		V(chopstick[(i+1) % 5]);
	}
}
```

* 死锁处理策略
  > - 什么都不干
  > - 死锁预防
  > - 死锁避免（银行家算法）（简单可直接查书）
  > - 死锁检测和恢复

* 死锁预防

条件          | 处理方式
--------------|:-------:
互斥          | 一切使用假脱机（Spooling）技术
占有和等待     | 在开始时就请求全部资源
不可抢占      | 抢占资源
循环等待      | 对资源按序编号

Spooling技术：例如当有多个进程访问打印机时，使用假脱机打印机技术使得它们都可以同时产生输出，但实际上真正使用打印机的进程是打印机守护进程（daemon），由于守护进程决不会请求别的资源，所以不会因打印机而死锁。虽然这种技术不会在打印机上死锁，但有可能在磁盘上死锁，但是又由于磁盘容量较大，要消耗完全部的磁盘空间一般是不可能的。

#### 典型例题

1. 一个进程的读磁盘操作完成后，操作系统针对该进程必做的是（ ）

    A. 修改进程为就绪态					B. 降低进程优先级

    C. 给进程分配内存空间					D. 增加进程时间片大小
    > Answer： A，当进程申请读磁盘操作时，进程需要等待IO操作完成会把自身阻塞，当IO操作完成，进程必定进入就绪态。这里必须知道进程阻塞在IO操作的真正含义。

2. 下列关于管道（pipe）通信的叙述中，正确的是（ ）

    A. 一个管道可实现双向数据传输			B. 管道的容量仅受磁盘容量大小限制

    C. 进程对管道进行读和写操作都可能被阻塞	D. 一个管道只能有一个读进程或写进程对其操作
    > Answer： C，管道实际上是半双工通信，同一时刻只能有一个方向的数据传输，D错；管道是一个固定大小的缓冲区，通常为内存中的一页，B错；

3. 假设当前系统正在执行三个进程P1，P2，P3；各进程的CPU时间和IO时间分别如下

    进程         | 计算时间       | IO时间
    :-----------:|:-------------:|:------:
    P1           | 90%           | 10%
    P2           | 50%           | 50%
    P3           | 15%           | 85%

    为提高系统资源利用率，合理的进程优先级设置为（ ）
   
    > Answer： P3 > P2> P1,IO繁忙型作业应该有最高优先级，这是因为只有这样，当高优先级的P3 CPU时间用完后，它在IO时，CPU可以继续去运行P2，这样CPU利用率才会高。本来这就是多道程序设计所要要求的。

4. 一个多道程序设计中仅有P1和P2两个作业，P2比P1晚5ms到达，它们的计算和IO顺序如下：

    P1： 计算60ms， IO 80ms， 计算20ms

    P2： 计算120ms，IO 40ms， 计算40ms

若不考虑调度和切换时间，则完成两个作业的最短时间为（ ）

Answer： 260ms，P1先到，显然要先运行；具体计算如下（-代表计算时间，=代表IO时间）：

P1： ------========&nbsp;&nbsp;&nbsp;&nbsp;--

P2： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ------------====----

### 存储管理

* 虚拟地址和物理地址的区别
> Real memory uses physical addresses. These are the numbers that the memory
chips react to on the bus. Virtual addresses are the logical addresses that refer to a process’ address space. Thus a machine with a 32-bit word can generate virtual addresses up to 4 GB regardless of whether the machine has more or less memory than 4 GB.

* 一个机器有38位的虚拟地址和32位的物理地址，一个有16KB个页，4字节表项的二级页表，应该对第一级页表分配多少位，对第二季页表分配多少位。
> Answer： 由 2^38 / 2^14 = 2^24,得到页面大小为2^24,因此需要24位偏移量，而二级页表的页表项为4字节，故PT2 = 2，因此PT1 = 38 - 2 - 24 = 12，所以一级页表12位，二级页表2位，页内偏移24位。

* 页表项个数 = 虚拟地址大小 / 页面大小。例如32位地址空间，页面大小4KB，则页表中的页表项
有： 2^(32 - 12) = 2^20个。页表项的大小：以32位机为例，共有32位逻辑地址空间，假设一页4KB，则页表项的个数最大有 2^20 = 1M 页，最少需要20位才能表示所有的页面，即页表项大小最少为 20 / 8 = 3B，又由于通常都取2的幂，所以最小为4B。每个进程都有自己的页表，又由于进程运行在内存中，所以页表也存在内存。

* 实现内存保护（保护操作系统不受用户进程的影响，同时保护用户进程不受其他进程的影响）
通过采用基址寄存器（最小的物理地址）和界址寄存器（进程最大地址长度，也是逻辑地址的最大长度）。

* 扩充内存的两种方法
  > - 覆盖：由于程序中并非任何时候都要访问程序以及数据的各个部分（尤其是大程序），因此可以将用户空间分为一个固定区和覆盖区，将经常活跃的部分放在固定区，其他部分在需要时调入覆盖区，替换覆盖原来的部分。
  > - 交换：把处于等待状态的进程从内存中移入磁盘，这叫换出；将准备好运行的进程从磁盘移入内存，这叫换入。

  交换技术主要是在不同进程之间进行的，覆盖技术则用于同一程序或进程中。

* **动态内存分配:**
  - 跟踪内存使用情况
    - 位图：将内存划分为小到几个字或大到几千字节的分配单元，每个分配单元对应于位图中的一位，0表示空闲，1表示占用（或相反）
    - 链表：维护一个记录已分配内存和空闲内存的链表，每一个节点包含以下域：空间区或进程占用的标志，起始地址，长度和指向下一个节点的指针
  - 分配策略
    - 首次适配（first fit）
    - 下次适配（next fit）
    - 最佳适配（best fit）
    - 最大适配（最坏适配）（worst fit）

* 分页
进程中的块称为页（Page）， 内存中的块称为页框（Page Frame）。分页是对进程而言的，而不是磁盘。因此我们通常所说的32位机，64位机都是对于进程而言的。以32位机为例，代表每个进程所能支持的最大虚拟地址空间位2^32.

* TLB（高速缓冲存储器，也叫相联存储器，也叫快表）

* 二级页表
以32位虚拟地址空间为例，每页大小4KB，每个页表项大小4B，为了查询的方便，顶级页表只能有一个页面（在内存中占4KB），那么 4KB / 4B = 1024个页表项，顶级页表占10位，则二级页表占 32 - 10 - 12 = 10 位，那么每一个二级页表的大小也是 4KB，也正好是一页的大小。

如果使用的是一级页表，则需要1M页，大小为1M * 4B = 4MB的空间。如果一个进程小于4MB大小，则这将是一个大大的浪费。

* 分段
虚拟地址32位，段号8位，则共有2^8=256个段，最大段长为2^24字节。

* 页面置换算法
  > - 最佳置换算法（OPT），替换最长时间内不在访问的页面，这需要我们提前知道页面的调用过程，例如有如下页面调用： 7 0 1 2 0 3 0 4 2 3 0，假设进程分配了3个物理块
  进程运行时，先将7 0 1发生缺页中断装入内存，然后2到来，发生缺页中断，根据OPT算法，7的访问时间较0和1要晚，则将7替换出去
  > - 先进先出（FIFO）
  **注意：只有FIFO算法会出现Belady异常（当所分配的物理块数增加，缺页中断不减反增的现象）**
  > - 第二次页面置换算法（FIFO的改进版），每一个页表项都设置有访问位（R位），当发生缺页中断时，检查最老页面的R位，如果为0，直接替换；如果为1，则清零，将该页面放入链表的尾端。这一算法称为第二次机会算法。
  > - 时钟页面置换算法，与第二次机会不同，使用一个环形来存储页面，而不是链表。
  > - 最近最少使用（LRU），仍以上面的例子，首先将7 0 1装入，然后当2到来时，观察到7为最近最少使用，替换出去7，此时使用顺序应该改为0 1 2，当0到来时，又变为1 2 0，当3到来时，又发生中断，替换出1，变为2 0 3等等。
  > - 老化算法（aging），参考现代操作系统
  > - 工作集（时钟）页面置换算法

* **抖动（颠簸）**
刚刚换出的页面马上又换入内存，刚刚换入的页面马上又换出内存，我们把这种现象称为抖动。也就是频繁地发生缺页中断。

* 正好TLB是和虚拟地址进行快速映射的，Cache是和物理地址进行快速映射的。

#### 典型例题

1. 在虚拟内存管理中，地址转换机构将逻辑地址转为物理地址，形成逻辑地址的阶段是（ ）

    A. 编辑				B. 编译				C. 链接				D. 装载
    > Answer： C，链接阶段主要完成重定位，生成二进制的.o文件。

2. 某计算机采用二级页表的分页存储管理方式，按字节编址，页大小为2^10字节，页表项大小为2字节，逻辑地址结构为：

    | 页目录号				| 页号           | 页内偏移量 |
    |:-------------:|:--------------:|----------:|
    |

    逻辑地址空间大小为2^16页，则表示整个逻辑地址空间的页目录表包含页表项个数至少是（ ）

    A. 64				B. 128				C. 256				D. 512
    > Answer： B，由页大小和页表项大小，可知一页可以存放 2^10 / 2 = 2^9个页表项。又由于共有2^16个页，即2^16个页表项，可知共需 2^16 / 2^9 = 2^7 = 128个页面。这也就是顶级页表（页目录表）包含的页表项个数。

3. 某计算机按字节编址，逻辑地址和物理地址都为32位，页表项大小为4B，若使用一级页表的分页存储管理方式，逻辑地址结构如下：

    页号（20位）			页内偏移量（12位）

    一个代码段的起始逻辑地址为0000 8000H，其长度为8KB，被装载到从物理地址0090 0000H开始的连续地址空间。页表从主存0020 0000H开始的物理地址处连续存放，请计算出该代码段两个页表项的物理地址，这两个页表项的页框号。

    > Answer： 由物理地址32位，按字节编址，共有内存大小2^32 = 4GB.由代码虚拟地址为0000 8000H，可知它的起始地址在页表中的第8页，一页又占4B，因此它的物理地址为： 0020 0000 + 8 * 4B = 0020 0020H。因此两个页表项物理地址为：0020 0020H， 0020 0024H。 又因为代码实际物理地址为 0090 0000H，则页框号（实际物理地址去除页内偏移量）为0090 0H，0090 1H。

4. 对下列虚拟存储器的叙述中，正确的是（ ）

    A. 虚拟存储器只能基于连续存储技术		B. 虚拟存储器只能基于非连续存储技术

    C. 虚拟存储器容量只受外存容量限制		D. 虚拟存储器容量只受内存容量限制

    > Answer： B，虚拟存储器容量只受CPU寻址范围决定，因此CD错误。连续存储技术：假设一个进程需要1GB内存，则就给它分配1GB内存，显然不能用于虚拟存储器，因此选B。

### 文件系统

* 文件系统布局
文件系统存放在磁盘上。多数磁盘划分为一个或多个分区（如C盘，D盘等），每个分区有一个独立的文件系统。磁盘的0号扇区称为**主引导记录（MBR）**，在计算机被引导时，BIOS读入并执行MBR，
MBR做的第一件事是确定活动分区，读入它的第一个块，称为**引导块（boot block）**并执行之
引导块的程序将装在分区中的操作系统。

* **文件控制块（FCB）和索引结点（i-结点）**
  > - 文件控制块是用来存放文件各种信息的数据结构。FCB的有序集合称为文件目录，一个FCB就是一个目录项。
  > - 有些系统采用将文件名和属性分开的方法，用i-结点作为存放文件属性的数据结构。
  可以理解为FCB = 文件名 + i-结点

* **软链接（symbol link）和硬链接（hard link）**

    现在考虑我们都要用户B可以共享用户A中的一个文件F（用户也可表示进程）
  > - 软链接：系统会在用户B下创建一个LINK类型的新文件，文件名字也叫F，里面存放内容为F的路径名，称为符号链接。考虑删除A中的文件，由于B中拥有的只是一个路径名，如果打开失败则直接删除这个LINK类型的文件就行。
  - 硬链接：每个索引节点都有一个count，当用户A创建一个新文件时，它的count=1。此时如果用户B硬链接到F上，设置一个指针指向给文件索引节点，则文件的主人仍然是A，此时两个用户的count=2.考虑删除A中的文件，由于文件已经不存在，则用户B中的指针将指向NULL，这样会使用户B的**指针悬空**。因此此时的删除操作并没有删除文件，只是将count减一，然后删除自己目录中的目录项。

* 目录实现
  
    要注意到，目录的实现其实就是为了查找，即找到相应目录或文件，有两种方式
  > - 线性列表，等同于数据结构中的顺序表和链表。
  - Hash列表

* 文件实现
    - 文件分配方式
        - 连续分配：把每个文件作为一连串的连续数据块存储在磁盘上，所以，在块大小为1KB的磁盘上，50KB的文件要分配50个连续的块。优点有：实现简单，存取速度快。缺点：文件长度不宜动态增加，会产生内部碎片。因而适用于大小固定的文件。例如CD-ROM。
        - 链表分配：为每个文件构建磁盘块链表，每个块的第一个字节作为指向下一块的指针，块的其他部分存放数据。优点：解决了内部碎片。缺点：指针占去字节，使得数据字节数不是2的幂，会出现一些怪异现象，影响系统性能；随机存取缓慢
        - 在内存中采用表的链表分配（FAT）：如果取出每个磁盘块的指针字，把它放在内存的一个表中。比如假设文件A共占有3个磁盘块，块号为：100， 160， 580.则比如我们已知文件A从磁盘块号为100开始，那么我们找到表中块号为100（其实就是内存地址）的位置，读出内存中的值作为下一个盘块号（160），依次读取内存中的数据即可。我们将这样一个表格称为**文件分配表（FAT）**。优点：减少磁盘IO，加快检索速度
        - 索引分配（使用i-结点）：给每个文件赋予一个i-结点的数据结构，其中包括文件属性和文件块的磁盘地址。只有对应文件打开，i-结点才在内存中。如果每个结点占n个字节，最多有k个文件被打开，则内存仅仅是kn个字节。比起FAT要大大减少。

    - 记录磁盘空闲块
        - 磁盘块链表
        - 位图
              
          类比内存空闲块的使用，基本相似。

* 磁盘调度算法
    - 磁盘结构：数据存储在磁盘的盘面上的一组同心圆上，称为**磁道**，每个盘面有上千个磁道，每个磁道上又划分为几百个**扇区**，每个扇区固定存储大小（通常为512B），通常被称为1个磁盘块。
    - 平均存取时间  = 寻道时间 + 延迟时间 + 传输时间
        - 寻道时间：将磁头移动到指定磁道所需要的时间

              Ts = m * n + s

              其中，m为与磁盘驱动器相关的常数，约为0.2ms，s为启动磁臂时间，约为2ms

        - 延迟时间：磁头定位到指定扇区的时间

              Tr = 1 / （2 * r）

              其中，r为磁盘转速，通常单位为 r/min,因需要转换为 r/s.

        - 传输时间：从磁盘读出数据或写入数据的时间
    			     Tt = b / （r * N）
              其中，b代表读出字节数，r表示转速，N表示一个磁道上的字节数

    - 磁盘调度算法
        - FCFS（先来先服务）
        - SSTF（最短寻道时间优先）
        - SCAN（也称电梯算法）
        - C-SCAN：当磁头到达一端的最远处，与SCAN不同，它直接返回到离另一端最近的磁道上。

#### 典型例题

1. 设文件F1的引用计数值为1，先建立文件F1的符号链接F2，再建立F1的硬链接F3，删除F1，则F2和F3的引用计数值分别为多少（ ）
> Answer： 1，1 建立符号链接时，引用计数值直接复制；建立硬链接时，引用计数值加一。建立完成后F1为2，F2为1，F3为2.删除F1后，F2不变，F3减一，因此为 1，1.

2. 若文件F1的硬链接为F2，两个进程分别打开F1，F2.获得对应的文件描述符fd1和fd2.则下列叙述中，正确的是（ ）

		I.   F1和F2的读写指针位置保持相同
		II.  F1和F2共享同一内存索引节点
		III. fd1和fd2分别指向各自的用户打开文件表中的一项
    A. III 			B. II,III  		C. I,II 		D. I,II,III
    > Answer： B，主要需要知道每个进程都维护自己的文件描述符。

3. 设文件索引结点中有7个地址项，其中4个是直接地址项，2个是一级间接地址项，1个是二级间接地址项，每个地址项大小为4B，若磁盘索引块和磁盘数据块大小均为256B，则可表示的单个文件最大长度是（ ）
> Answer： 1057KB， 首先我们要搞清楚i-结点多级索引的意义。直接地址项意味着这个里面的内容就是一个磁盘块的块号。因此大小为 4 * 256B。一级间接地址项代表每个内容是 磁盘索引块的块号。每个磁盘索引块是由具体的磁盘块号组成的，而每个磁盘索引块大小为256B， 每个地址项大小4B，则共有256 / 4个地址项，每个又代表着256B的磁盘数据块，则大小为2 * 256 / 4 * 256B。依次类推，共有 4 * 256 + 2 * 256/4 * 256 + 1 * 256/4 * 256/4 * 256 = 1057KB.

4. 文件系统使用位图法表示磁盘空间的分配情况，位图位于磁盘的32-127号块中，每个盘块大小为1024字节，盘块和块内字节从0开始编号。假设要释放的盘块号为409612，则位图中要修改的位所在的磁盘号和块内字节序号分别是（ ）

    A. 81,1			B. 81,2			C. 82,1			D. 82,2
> Answer： C，由于位图法是每个盘块一位，即409612号是第 409612位，共占409612 / 1024 / 8 = 50 块，由于位图的其实块号为32，因此要修改的位所在的磁盘块号为82。块内字节序号为 （磁盘块号 %（1024 * 8）） / 8 = 1.

5. 某文件系统为一级目录列表结构，文件的数据一次写入磁盘，已写入的文件不可修改，但可多次创建新文件。请回答以下问题：

    1） 在连续，链式，索引三种文件数据块的组织方式中，哪种更合适？为定位文件数据块，FCB中需要哪些描述字段

    2） 为快速找到文件，对于FCB，是集中存储好，还是与对应的文件数据库连续存储好？

    3） 假定磁盘块大小为1KB，对于540MB的磁盘，其文件分配表（FAT）最少需要占用多少空间

    > Answer： 
    1） 由题意，数据写入不可修改，连续更适合，因为实现简单，且随机存取速度快。需要
< 起始块地址， 块数 >这两个字段。
    2） 集中存储好。这样当查找文件名时，只需到FCB找就可以了，减少了磁盘IO次数。
		3） 共有540MB / 1KB = 540 * 2^10个块， 由于这个数小于2^20大于2^19，因此最少需要20位才能表示一个块号。而文件分配表正好是一个块号对应一项。每一项需要 20 / 8 = 2.5字节。共有 540 * 2^10 * 2.5 = 1350KB.

6. 某文件系统空间的最大容量为4TB（1TB = 2^40B)，以磁盘块为分配单位，磁盘块大小为1KB。文件控制块（FCB）包含一个512B的索引表区请回答下列问题：

    1） 假设索引表区仅采用直接索引结构，索引表区存放文件占用的磁盘块号，索引表项中块号最少占多少字节？可支持的单个文件大小最大为多少字节？

    2） 假设索引表区采用如下结构，第0-7字节采用 < 起始块号， 块数 >格式表示文件创建时预分配的连续存储空间。其中起始块号为6B，块数为2B，剩余504字节采用直接索引结构，一个索引项占6B,则可支持的单个文件最大长度为多少字节？为了使单个文件长度达到最大，请指出起始块号和块数分别占字节数的合理值。

Answer：

1）磁盘共分为 4TB / 1KB = 2^32个，至少需要32位 = 4B来表示，因此块号最少占4字节。512B索引表区共有 512 / 4 = 128 个表项，一项代表一个磁盘块，因此单个文件最大长度为 128 * 1KB = 128KB。

2）由分析可知，块数为2B，共有16位，能够表示2^16个块号，剩余504/6 = 84个块号，共有(2^16 + 84) * 1KB = 64MB + 84KB.设起始块号为 x B，则块数为（8-x）B，则最大长度为 (pow(2, (8-x) * 8) + 84) * 1KB.因此只有当x == 4时取最大值。同时起始块号为4B正好可以表示4TB磁盘容量。

### 输入/输出（I/O）管理

* I/O实现方式
    - 程序直接控制I/O：例如打印机，当输出一个字符后，CPU要不断查询设备是否就绪准备接受下一个字符。程序设计简单，但又缺点：CPU利用率低
    - 中断驱动I/O
    - DMA方式：每一个I/O设备一个DMA控制器用于I/O的输入输出。
    - 通道方式：DMA的改进，一个通道可以同时控制多个I/O设备输入输出。

* I/O系统层次结构
    - 用户层I/O软件
    - 设备无关性软件
    - 设备驱动程序
    - 中断处理程序
    - 硬件

一般过程为： 比如用户写了一段C程序，其中有以下代码`count = write(fd, buffer, size);`
则write调用是一个系统调用，可以看成用户层IO；然后操作系统在内核启动系统调用处理程序，可以看作设备无关性软件；处理完成后，需要启动磁盘I/O写入文件，为设备驱动程序；当I/O完成，内容全部写入文件时，产生中断，通知系统可以继续运行干其他事情了，此为中断处理程序。

* I/O子系统
    - I/O调度：就是确定一个好的顺序执行I/O请求，一次来改善系统性能。磁盘调度算法就是I/O调度的一种
    - 缓冲区和磁盘高速缓存
    - 设备分配与回收
    - Spooling（假脱机）技术：以磁盘空间换取时间的技术，因为打印机的速度远远小于
  磁盘速度。